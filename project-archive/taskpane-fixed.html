<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>RHEI AI Legal Assistant</title>

    <!-- Office JavaScript API with CRITICAL FIX -->
    <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1.1/hosted/office.js"></script>
    <script type="text/javascript">
        // CRITICAL FIX: Multiple layers of error handling for Office.HostApplication

        // Layer 1: Global error handler to catch Office.HostApplication errors
        window.addEventListener('error', function(event) {
            console.log('Global error caught:', event.error);
            if (event.error && event.error.message && event.error.message.includes("Cannot read properties of undefined (reading 'Word')")) {
                console.warn("FIXED: Office.HostApplication.Word error caught and handled");
                event.preventDefault();
                return false;
            }
        });

        // Layer 2: Unhandled promise rejection handler
        window.addEventListener('unhandledrejection', function(event) {
            console.log('Unhandled promise rejection caught:', event.reason);
            if (event.reason && event.reason.message && event.reason.message.includes("Cannot read properties of undefined (reading 'Word')")) {
                console.warn("FIXED: Office.HostApplication.Word promise rejection caught and handled");
                event.preventDefault();
                return false;
            }
        });

        // Layer 3: Override Office.HostApplication if undefined
        function ensureOfficeHostApplication() {
            if (typeof Office !== 'undefined' && typeof Office.HostApplication === 'undefined') {
                console.warn("FIXING: Office.HostApplication is undefined, creating mock object");
                Office.HostApplication = {
                    Word: 'Word',
                    Excel: 'Excel',
                    PowerPoint: 'PowerPoint',
                    Outlook: 'Outlook',
                    OneNote: 'OneNote',
                    Project: 'Project',
                    Access: 'Access'
                };
                console.log("FIXED: Office.HostApplication mock object created");
            }
        }

        // Layer 4: Try to fix Office.HostApplication before any other code runs
        if (typeof Office !== 'undefined') {
            ensureOfficeHostApplication();
        } else {
            // Wait for Office to load, then fix it
            let officeCheckInterval = setInterval(() => {
                if (typeof Office !== 'undefined') {
                    ensureOfficeHostApplication();
                    clearInterval(officeCheckInterval);
                }
            }, 100);
        }

        // Enhanced Office.onReady with multiple layers of HostApplication fixes
        function initializeOfficeWithFix() {
            console.log("Starting Office initialization with comprehensive HostApplication fix...");

            if (typeof Office !== 'undefined') {
                // Ensure Office.HostApplication exists before calling Office.onReady
                ensureOfficeHostApplication();

                try {
                    // Wrap Office.onReady in additional error handling
                    const safeOfficeOnReady = function(callback) {
                        try {
                            return Office.onReady(callback);
                        } catch (error) {
                            console.error("Office.onReady error:", error);
                            if (error.message && error.message.includes("Cannot read properties of undefined (reading 'Word')")) {
                                console.warn("FIXED: Office.onReady HostApplication error caught, proceeding with fallback");
                                // Call the callback with a mock info object
                                callback({ host: 'Word', platform: 'Web' });
                            } else {
                                throw error;
                            }
                        }
                    };

                    safeOfficeOnReady((info) => {
                        console.log("Office.onReady called with info:", info);
                        window.OFFICE_READY = true;

                        // CRITICAL FIX: Multiple checks for Office.HostApplication
                        let hostType = 'unknown';

                        if (typeof Office.HostApplication === 'undefined') {
                            console.warn("FIXED: Office.HostApplication is undefined, assuming Word environment");
                            hostType = 'Word';
                        } else if (info && info.host === Office.HostApplication.Word) {
                            console.log("RHEI AI Legal Assistant loaded successfully in Word");
                            hostType = 'Word';
                        } else if (info && typeof info.host === 'string' && info.host.toLowerCase().includes('word')) {
                            console.log("Host detected as Word via string comparison");
                            hostType = 'Word';
                        } else {
                            console.log("Host application:", info ? info.host : "unknown", "- proceeding anyway");
                            hostType = 'Word'; // Assume Word for our add-in
                        }

                        console.log("Detected host type:", hostType);
                        initializeWordFeatures();
                    });
                } catch (error) {
                    console.error("Error in Office.onReady setup:", error);
                    console.warn("FIXED: Proceeding with basic initialization due to Office.onReady error");
                    initializeBasicFeatures();
                }
            } else {
                console.error("Office.js not available");
                initializeBasicFeatures();
            }
        }

        function initializeWordFeatures() {
            console.log("Initializing Word features...");
            
            // Check for Word API
            if (typeof Word !== 'undefined' && typeof Word.run === 'function') {
                console.log("Word API is available!");
                window.WORD_API_AVAILABLE = true;
                updateStatus("Word API available - all features enabled", "success");
            } else {
                console.log("Word API not available - using demo mode");
                window.WORD_API_AVAILABLE = false;
                updateStatus("Demo mode - Word API not available", "warning");
            }
            
            setupUI();
        }

        function initializeBasicFeatures() {
            console.log("Initializing basic features...");
            window.WORD_API_AVAILABLE = false;
            updateStatus("Basic mode - limited functionality", "warning");
            setupUI();
        }

        function setupUI() {
            console.log("Setting up UI...");

            // Initialize playbook service
            initializePlaybookService();

            // Enable buttons based on API availability
            console.log("üîò Setting up button states...");
            console.log("WORD_API_AVAILABLE:", window.WORD_API_AVAILABLE);

            const buttons = document.querySelectorAll('button');
            console.log("Found buttons:", buttons.length);

            buttons.forEach(button => {
                // Always enable these buttons regardless of Word API availability
                const alwaysEnabledButtons = ['show-diagnostics', 'test-word-api', 'generate-contract'];

                console.log(`Button: ${button.id}, always enabled: ${alwaysEnabledButtons.includes(button.id)}`);

                if (window.WORD_API_AVAILABLE || alwaysEnabledButtons.includes(button.id)) {
                    button.disabled = false;
                    if (!window.WORD_API_AVAILABLE && button.id === 'generate-contract') {
                        button.title = "Generate contract (demo mode - will show preview)";
                        console.log("‚úÖ Generate contract button enabled for demo mode");
                    } else if (button.id === 'generate-contract') {
                        console.log("‚úÖ Generate contract button enabled for Word API mode");
                    }
                } else {
                    button.disabled = true;
                    button.title = "Requires Word API - not available";
                    console.log(`‚ùå Button ${button.id} disabled`);
                }
            });

            // Special check for generate contract button
            const generateBtn = document.getElementById('generate-contract');
            if (generateBtn) {
                console.log(`üéØ Generate contract button final state: disabled=${generateBtn.disabled}, title="${generateBtn.title}"`);
            }
        }

        async function initializePlaybookService() {
            console.log("Initializing playbook service...");

            try {
                // Create a simple playbook service for the taskpane
                window.playbookService = {
                    async getAlternativeClauses(clauseNumber, agreementType = 'content-management', contentType = 'general') {
                        console.log(`Getting alternatives for clause ${clauseNumber}`);

                        // For now, return mock data with clause-specific content
                        return [
                            {
                                id: 'baseline',
                                title: 'BASELINE (Ninja Tune Ltd.)',
                                content: `This is the baseline clause text for ${clauseNumber} from the RHEI Legal Matrix. It represents the standard acceptable language for this type of clause and has been reviewed for compliance with industry standards.`,
                                riskLevel: 'low',
                                recommended: true,
                                source: 'legal_matrix'
                            },
                            {
                                id: 'yoola',
                                title: 'Yoola Alternative',
                                content: `Alternative clause text for ${clauseNumber} suitable for Yoola agreements. This version includes specific provisions that align with Yoola's business requirements while maintaining legal protections.`,
                                riskLevel: 'low',
                                recommended: false,
                                source: 'legal_matrix'
                            },
                            {
                                id: 'sony',
                                title: 'Sony Alternative',
                                content: `Sony-specific clause language for ${clauseNumber} that meets their contractual requirements. This version includes enhanced reporting obligations and specific performance metrics.`,
                                riskLevel: 'medium',
                                recommended: false,
                                source: 'legal_matrix'
                            },
                            {
                                id: 'lionsgate',
                                title: 'Lionsgate Alternative',
                                content: `Lionsgate preferred clause structure for ${clauseNumber} with enhanced liability protections and specific performance requirements. This version includes additional indemnification clauses.`,
                                riskLevel: 'medium',
                                recommended: false,
                                source: 'legal_matrix'
                            },
                            {
                                id: 'conservative',
                                title: 'Conservative Option',
                                content: `Conservative alternative for ${clauseNumber} that minimizes risk exposure. This version includes additional protective language and stricter compliance requirements.`,
                                riskLevel: 'low',
                                recommended: false,
                                source: 'playbook'
                            }
                        ];
                    }
                };

                console.log("Playbook service initialized successfully");

            } catch (error) {
                console.error("Error initializing playbook service:", error);
                // Fallback will be handled in loadAlternativeClauses
            }
        }

        function updateStatus(message, type) {
            const statusElement = document.getElementById('status-message');
            if (statusElement) {
                statusElement.textContent = message;
                statusElement.className = `status-message ms-font-s ${type || ''}`;
            }
            console.log(`Status: ${message}`);
        }

        function testWordAPI() {
            console.log("Testing Word API...");
            
            if (typeof Word !== 'undefined' && typeof Word.run === 'function') {
                Word.run(async (context) => {
                    console.log("Word API test successful!");
                    updateStatus("Word API test successful!", "success");
                }).catch(error => {
                    console.error("Word API test failed:", error);
                    updateStatus("Word API test failed: " + error.message, "error");
                });
            } else {
                updateStatus("Word API not available for testing", "warning");
            }
        }

        function showDiagnostics() {
            const diagnostics = {
                officeLoaded: typeof Office !== 'undefined',
                officeReady: window.OFFICE_READY || false,
                hostApplication: typeof Office?.HostApplication !== 'undefined',
                wordApi: typeof Word !== 'undefined',
                wordRun: typeof Word?.run === 'function',
                wordApiAvailable: window.WORD_API_AVAILABLE || false
            };

            console.log("Diagnostics:", diagnostics);

            const message = `Office: ${diagnostics.officeLoaded ? 'Loaded' : 'Not Loaded'}, ` +
                          `Ready: ${diagnostics.officeReady ? 'Yes' : 'No'}, ` +
                          `HostApp: ${diagnostics.hostApplication ? 'Available' : 'Undefined'}, ` +
                          `Word API: ${diagnostics.wordApi ? 'Available' : 'Not Available'}`;

            updateStatus(message, "info");
        }

        function analyzeContract() {
            console.log("Starting contract analysis...");
            showProgress("Analyzing contract for compliance and acceptability...");

            if (typeof Word !== 'undefined' && typeof Word.run === 'function') {
                // Real Word API analysis
                Word.run(async (context) => {
                    const body = context.document.body;
                    body.load("text");
                    await context.sync();

                    const documentText = body.text;
                    console.log("Document text length:", documentText.length);

                    // Simulate analysis
                    setTimeout(() => {
                        displayAnalysisResults(generateMockAnalysisResults(documentText));
                        hideProgress();
                    }, 2000);
                }).catch(error => {
                    console.error("Word API error:", error);
                    displayDemoAnalysis();
                    hideProgress();
                });
            } else {
                // Demo mode analysis
                setTimeout(() => {
                    displayDemoAnalysis();
                    hideProgress();
                }, 2000);
            }
        }

        async function generateContract() {
            console.log("üöÄ GENERATE CONTRACT BUTTON CLICKED!");
            console.log("Current timestamp:", new Date().toISOString());

            // Visual confirmation that button was clicked
            const statusElement = document.getElementById('status-message');
            if (statusElement) {
                statusElement.textContent = "Generate Contract button clicked! Processing...";
                statusElement.className = "status-message ms-font-s info";
            }

            // Remove alert and continue with normal processing

            // Check if elements exist
            const contractTypeSelect = document.getElementById('contract-type-select');
            console.log("Contract type select element:", contractTypeSelect);
            console.log("Contract type value:", contractTypeSelect ? contractTypeSelect.value : 'NOT FOUND');

            showProgress("Generating contract from template...");
            console.log("Progress shown, starting generation...");

            try {
                // Get selected contract type from dropdown
                const selectedContractType = contractTypeSelect ? contractTypeSelect.value : 'content-management';
                console.log("Selected contract type:", selectedContractType);

                // Generate contract using direct TSV approach
                console.log("Calling generateContractFromTSV with type:", selectedContractType);
                const result = await generateContractFromTSV(selectedContractType);
                console.log("generateContractFromTSV result:", result);

                if (result.success) {
                    updateStatus("Contract generated successfully!", "success");

                    // If Word API is available, insert into document with formatting
                    if (window.WORD_API_AVAILABLE && typeof Word !== 'undefined') {
                        try {
                            await Word.run(async (context) => {
                                const body = context.document.body;
                                body.clear();

                                // Insert contract text
                                const contractRange = body.insertText(result.contract_text, Word.InsertLocation.start);

                                // Apply basic formatting with error handling
                                try {
                                    contractRange.font.name = "Times New Roman";
                                    contractRange.font.size = 12;

                                    // Check if alignment property exists before setting
                                    if (contractRange.paragraphFormat && typeof contractRange.paragraphFormat.alignment !== 'undefined') {
                                        contractRange.paragraphFormat.alignment = Word.Alignment.justified;
                                    }

                                    if (contractRange.paragraphFormat) {
                                        contractRange.paragraphFormat.lineSpacing = 18; // 1.5 line spacing
                                        contractRange.paragraphFormat.spaceAfter = 6;
                                        contractRange.paragraphFormat.keepWithNext = true;
                                    }
                                } catch (formatError) {
                                    console.log("Formatting not fully supported, using basic insertion:", formatError);
                                }

                                await context.sync();
                            });
                            updateStatus("Contract inserted into Word document!", "success");
                        } catch (wordError) {
                            console.error("Word API error:", wordError);
                            updateStatus("Contract generated but couldn't insert into Word. See preview below.", "warning");
                            // Fall through to show preview
                        }
                    } else {
                        // Demo mode - show contract in results section
                        console.log("üìã Demo mode: showing contract in results section");
                        console.log("WORD_API_AVAILABLE:", window.WORD_API_AVAILABLE);
                        console.log("typeof Word:", typeof Word);

                        const resultsContent = document.getElementById('results-content');
                        const resultsSection = document.getElementById('results-section');
                        console.log("Results elements found:", { resultsContent: !!resultsContent, resultsSection: !!resultsSection });

                        if (resultsContent && resultsSection) {
                            resultsContent.innerHTML = `
                                <h3>Generated Contract (Demo Mode)</h3>
                                <div class="contract-preview">
                                    <pre style="white-space: pre-wrap; font-family: 'Times New Roman', serif; font-size: 12px; line-height: 1.5;">${result.contract_text}</pre>
                                </div>
                            `;
                            resultsSection.style.display = 'block';
                            console.log("‚úÖ Contract displayed in demo mode");
                            updateStatus("Contract generated successfully (demo mode)", "success");
                        } else {
                            console.error("‚ùå Results elements not found");
                            updateStatus("Contract generated but couldn't display preview", "warning");
                        }
                    }
                } else {
                    throw new Error(result.error || 'Contract generation failed');
                }

            } catch (error) {
                console.error("Contract generation error:", error);
                updateStatus("Failed to generate contract: " + error.message, "error");
            } finally {
                hideProgress();
            }
        }

        function showProgress(message) {
            const progressSection = document.getElementById('progress-section');
            const progressMessage = document.getElementById('progress-message');
            if (progressSection && progressMessage) {
                progressMessage.textContent = message;
                progressSection.style.display = 'block';
            }
        }

        function hideProgress() {
            const progressSection = document.getElementById('progress-section');
            if (progressSection) {
                progressSection.style.display = 'none';
            }
        }

        // Direct contract generation from TSV
        async function generateContractFromTSV(contractType) {
            console.log("üìÑ generateContractFromTSV called with type:", contractType);
            try {
                let tsvData;

                // Load the appropriate TSV file
                console.log("Loading TSV file for contract type:", contractType);
                if (contractType === 'content-management') {
                    console.log("Fetching ContentManagement.tsv...");
                    const response = await fetch('./playbooks/ContentManagement.tsv');
                    console.log("Fetch response status:", response.status, response.statusText);
                    if (!response.ok) {
                        throw new Error(`Failed to load ContentManagement.tsv: ${response.status} ${response.statusText}`);
                    }
                    tsvData = await response.text();
                    console.log("ContentManagement.tsv loaded, length:", tsvData.length);
                } else if (contractType === 'data-pro') {
                    console.log("Fetching DataPro.tsv...");
                    const response = await fetch('./playbooks/DataPro.tsv');
                    console.log("Fetch response status:", response.status, response.statusText);
                    if (!response.ok) {
                        throw new Error(`Failed to load DataPro.tsv: ${response.status} ${response.statusText}`);
                    }
                    tsvData = await response.text();
                    console.log("DataPro.tsv loaded, length:", tsvData.length);
                } else {
                    throw new Error(`Unknown contract type: ${contractType}`);
                }

                // Parse TSV data
                const lines = tsvData.split('\n');
                // Skip the first line (tier info) and use the second line as headers
                const headers = lines[1].split('\t');

                console.log('TSV Headers found:', headers);

                // Find the baseline clause text column
                let clauseTextColumn = -1;
                for (let i = 0; i < headers.length; i++) {
                    const header = headers[i].trim();
                    console.log(`Checking header ${i}: "${header}"`);
                    if (header.includes('Full Clause Text BASELINE') ||
                        header.includes('Full Clause Text (Original)') ||
                        header.includes('Clause Summary BASELINE') ||
                        header.toLowerCase().includes('baseline') && header.toLowerCase().includes('clause')) {
                        clauseTextColumn = i;
                        console.log(`Found baseline column at index ${i}: "${header}"`);
                        break;
                    }
                }

                if (clauseTextColumn === -1) {
                    // Fallback: try column 6 which should be "Full Clause Text BASELINE (Ninja Tune Ltd.)"
                    if (headers.length > 6 && headers[6] && headers[6].includes('BASELINE')) {
                        clauseTextColumn = 6;
                        console.log(`Using fallback column 6: "${headers[6]}"`);
                    } else {
                        console.error('Available headers:', headers);
                        throw new Error('Could not find baseline clause text column in TSV data');
                    }
                }

                // Build the contract
                console.log("Building contract for type:", contractType);
                let contractText = '';

                if (contractType === 'content-management') {
                    console.log("Calling buildContentManagementContract...");
                    contractText = buildContentManagementContract(lines, clauseTextColumn);
                    console.log("Content Management contract built, length:", contractText.length);
                } else if (contractType === 'data-pro') {
                    console.log("Calling buildDataProContract...");
                    contractText = buildDataProContract(lines, clauseTextColumn);
                    console.log("Data Pro contract built, length:", contractText.length);
                }

                console.log("Contract text preview (first 200 chars):", contractText.substring(0, 200));

                const result = {
                    success: true,
                    contract_text: contractText,
                    method: 'tsv_template'
                };

                console.log("Returning result:", { success: result.success, textLength: result.contract_text.length, method: result.method });
                return result;

            } catch (error) {
                console.error('Error generating contract from TSV:', error);
                return {
                    success: false,
                    error: error.message
                };
            }
        }

        // Start initialization after page load
        window.addEventListener('load', function() {
            console.log("üöÄ Page loaded, starting initialization...");
            console.log("Current URL:", window.location.href);
            console.log("User Agent:", navigator.userAgent);

            // Add visual indicator that page is loading
            const statusElement = document.getElementById('status-message');
            if (statusElement) {
                statusElement.textContent = "Initializing RHEI AI Legal Assistant...";
                statusElement.className = "status-message ms-font-s info";
            }

            setTimeout(initializeOfficeWithFix, 1000);
        });

        function displayAnalysisResults(analysisResult) {
            const resultsContent = document.getElementById('results-content');
            const resultsSection = document.getElementById('results-section');

            if (!resultsContent || !resultsSection) return;

            const structure = analysisResult.contract_structure;
            const modifiedClauses = structure.articles.reduce((count, article) =>
                count + article.clauses.filter(clause => clause.changeStatus?.isModified).length, 0);
            const totalClauses = structure.articles.reduce((count, article) => count + article.clauses.length, 0);

            let html = `
                <div class="analysis-results">
                    <!-- Contract Structure Breakdown -->
                    <div class="analysis-section contract-structure">
                        <h3>üìã Contract Structure</h3>
                        <div class="structure-overview">
                            <p><strong>Total Articles:</strong> ${structure.articles.length}</p>
                            <p><strong>Total Clauses:</strong> ${totalClauses}</p>
                            <p><strong>Modified Clauses:</strong> <span style="color: #d13438;">${modifiedClauses}</span></p>
                            <p><strong>Unmodified Clauses:</strong> <span style="color: #107c10;">${totalClauses - modifiedClauses}</span></p>
                        </div>

                        <div class="articles-breakdown">`;

            // Display each article with its clauses
            structure.articles.forEach(article => {
                html += `
                    <div class="article-item">
                        <h4 class="article-title">${article.number}. ${article.title}</h4>
                        <div class="clauses-list">`;

                article.clauses.forEach(clause => {
                    const statusClass = clause.changeStatus?.isModified ? 'modified' : 'unmodified';
                    const statusColor = clause.changeStatus?.isModified ? '#d13438' : '#107c10';

                    html += `
                        <div class="clause-item ${statusClass}" onclick="selectClause('${clause.number}', this)" data-clause-number="${clause.number}">
                            <span class="clause-number" style="color: ${statusColor};">${clause.number}</span>
                            <span class="clause-text">${clause.text.substring(0, 100)}${clause.text.length > 100 ? '...' : ''}</span>
                            <div class="clause-actions">
                                ${clause.changeStatus?.isModified ? `
                                    <button class="modify-button" onclick="event.stopPropagation(); applyClauseChange('${clause.number}')">Apply Change</button>
                                    <button class="preview-button" onclick="event.stopPropagation(); previewClauseChange('${clause.number}')">Preview</button>
                                ` : ''}
                                <button class="replace-button" onclick="event.stopPropagation(); openReplacementModal('${clause.number}')">üîÑ Replace</button>
                            </div>
                        </div>`;
                });

                html += `
                        </div>
                    </div>`;
            });

            html += `
                        </div>

                        ${modifiedClauses > 0 ? `
                            <div class="auto-update-controls">
                                <label class="auto-update-checkbox">
                                    <input type="checkbox" id="auto-update-all" onchange="toggleAutoUpdate(this.checked)">
                                    <span>Automatically Update All Clauses</span>
                                </label>
                                <button class="accept-all-button" onclick="acceptAllChanges()">
                                    ‚úÖ Accept All Changes (${modifiedClauses})
                                </button>
                            </div>
                        ` : ''}
                    </div>
                </div>`;

            resultsContent.innerHTML = html;
            resultsSection.style.display = 'block';
        }

        function displayDemoAnalysis() {
            const demoResult = generateMockAnalysisResults("Demo contract content for testing purposes...");
            displayAnalysisResults(demoResult);
        }

        function generateMockAnalysisResults(documentText) {
            return {
                contract_structure: {
                    articles: [
                        {
                            number: "1",
                            title: "Definitions and Interpretation",
                            clauses: [
                                {
                                    number: "1.1",
                                    text: "In this Agreement, the following terms shall have the meanings set forth below...",
                                    changeStatus: { isModified: false }
                                },
                                {
                                    number: "1.2",
                                    text: "The headings in this Agreement are for convenience only and shall not affect interpretation...",
                                    changeStatus: { isModified: true }
                                }
                            ]
                        },
                        {
                            number: "2",
                            title: "Grant of Rights",
                            clauses: [
                                {
                                    number: "2.1",
                                    text: "Subject to the terms and conditions of this Agreement, Licensor hereby grants...",
                                    changeStatus: { isModified: true }
                                },
                                {
                                    number: "2.2",
                                    text: "The rights granted hereunder are non-exclusive and non-transferable...",
                                    changeStatus: { isModified: false }
                                }
                            ]
                        },
                        {
                            number: "3",
                            title: "Term and Termination",
                            clauses: [
                                {
                                    number: "3.1",
                                    text: "This Agreement shall commence on the Effective Date and continue for a period...",
                                    changeStatus: { isModified: false }
                                },
                                {
                                    number: "3.2",
                                    text: "Either party may terminate this Agreement upon thirty (30) days written notice...",
                                    changeStatus: { isModified: true }
                                }
                            ]
                        }
                    ]
                }
            };
        }

        // Helper functions for building contracts
        function buildContentManagementContract(lines, clauseTextColumn) {
            console.log("üìã buildContentManagementContract called");
            console.log("Lines count:", lines.length);
            console.log("Clause text column:", clauseTextColumn);

            // Get form data
            console.log("Getting form data...");
            const formData = getFormData();
            console.log("Form data:", formData);

            // Extract articles and clauses for table of contents
            console.log("Extracting articles from TSV...");
            const articles = extractArticlesFromTSV(lines, clauseTextColumn);
            console.log("Articles extracted:", articles.length);

            console.log("Formatting contract header...");
            let contract = formatContractHeader(formData);
            console.log("Header length:", contract.length);

            console.log("Generating table of contents...");
            contract += generateTableOfContents(articles);
            console.log("After TOC length:", contract.length);

            console.log("Generating recitals...");
            contract += generateRecitals(formData);
            console.log("After recitals length:", contract.length);

            // Process clauses from TSV (start from line 2 since line 1 is now headers)
            console.log("Processing clauses from TSV...");
            let clausesProcessed = 0;
            for (let i = 2; i < lines.length; i++) {
                const columns = lines[i].split('\t');
                if (columns.length > clauseTextColumn && columns[clauseTextColumn] && columns[clauseTextColumn].trim()) {
                    const clauseText = columns[clauseTextColumn].trim();

                    // Skip title page, table of contents, and recitals entries (we generate these)
                    if (clauseText.includes('DIGITAL VIDEO SERVICES AGREEMENT BETWEEN') ||
                        clauseText.includes('ARTICLE 1 INTERPRETATION') ||
                        columns[0] === 'Title Page' ||
                        columns[0] === 'Table of Contents' ||
                        columns[0] === 'RECITALS') {
                        console.log(`Skipping line ${i}: ${clauseText.substring(0, 50)}...`);
                        continue;
                    }

                    // Add formatted clause with proper numbering
                    const articleColumn = columns[1] || '';
                    const clauseColumn = columns[2] || '';

                    if (articleColumn && clauseColumn) {
                        // Replace placeholder text with actual form data
                        let processedClauseText = replacePlaceholders(clauseText, formData);
                        contract += formatClause(articleColumn, clauseColumn, processedClauseText);
                        clausesProcessed++;
                        if (clausesProcessed <= 3) {
                            console.log(`Added clause ${articleColumn} ${clauseColumn}: ${clauseText.substring(0, 50)}...`);
                        }
                    }
                }
            }
            console.log(`Total clauses processed: ${clausesProcessed}`);

            console.log("Generating schedules...");
            contract += generateSchedules(formData);
            console.log("Final contract length:", contract.length);

            console.log("‚úÖ buildContentManagementContract completed");
            return contract;
        }

        function buildDataProContract(lines, clauseTextColumn) {
            let contract = `DATA LICENSE AGREEMENT

BETWEEN: RHEI CREATIONS CORP.
AND: PROVIDER NAME, INC.

Effective Date: ${new Date().toLocaleDateString()}

`;

            // Process clauses from TSV (start from line 2 since line 1 is now headers)
            for (let i = 2; i < lines.length; i++) {
                const columns = lines[i].split('\t');
                if (columns.length > clauseTextColumn && columns[clauseTextColumn] && columns[clauseTextColumn].trim()) {
                    const clauseText = columns[clauseTextColumn].trim();

                    // Skip cover sheet entries that are already included
                    if (clauseText.includes('This Data License Agreement') ||
                        clauseText.includes('The following is to be completed')) {
                        continue;
                    }

                    // Add section headers
                    const sectionColumn = columns[2] || '';
                    if (sectionColumn && sectionColumn.trim()) {
                        contract += `${sectionColumn.toUpperCase()}\n`;
                    }

                    contract += clauseText + '\n\n';
                }
            }

            return contract;
        }

        // Form data processing functions
        function getFormData() {
            return {
                companyName: 'RHEI Creations Inc.',
                companyAddress: '600-777 Hornby St, Vancouver, BC, Canada, V6Z1S4',
                providerName: document.getElementById('provider-name')?.value || 'Provider Name, Inc.',
                providerAddress: document.getElementById('provider-address')?.value || 'Provider Address',
                effectiveDate: document.getElementById('effective-date')?.value || new Date().toLocaleDateString(),
                agreementTitle: document.getElementById('agreement-title')?.value || 'DIGITAL VIDEO SERVICES AGREEMENT'
            };
        }

        function getCompanyShortName(fullName) {
            // Always return RHEI for our company
            return 'RHEI';
        }

        function extractArticlesFromTSV(lines, clauseTextColumn) {
            const articles = [];

            for (let i = 2; i < lines.length; i++) {
                const columns = lines[i].split('\t');
                if (columns.length > 2 && columns[1] && columns[2]) {
                    const articleNum = columns[1].trim();
                    const clauseTitle = columns[2].trim();

                    if (articleNum.startsWith('ARTICLE') && !articles.find(a => a.number === articleNum)) {
                        articles.push({
                            number: articleNum,
                            title: clauseTitle,
                            clauses: []
                        });
                    } else if (articleNum && clauseTitle && !articleNum.includes('N/A')) {
                        const currentArticle = articles[articles.length - 1];
                        if (currentArticle) {
                            currentArticle.clauses.push({
                                number: articleNum,
                                title: clauseTitle
                            });
                        }
                    }
                }
            }

            return articles;
        }

        function generateTableOfContents(articles) {
            let toc = `TABLE OF CONTENTS

`;

            articles.forEach(article => {
                toc += `${article.number} ${article.title.toUpperCase()} ........................... Page X\n`;
                article.clauses.forEach(clause => {
                    toc += `  ${clause.number} ${clause.title} ........................... Page X\n`;
                });
                toc += '\n';
            });

            toc += `SCHEDULES ........................... Page X\n`;
            toc += `SCHEDULE "A" ‚Äì LIST OF MANAGED CHANNELS ........................... Page X\n`;
            toc += `SCHEDULE "B" ‚Äì CHANNEL MANAGEMENT SERVICES ........................... Page X\n`;
            toc += `SCHEDULE "C" ‚Äì CONTENT DEVELOPMENT SERVICES ........................... Page X\n\n`;

            return toc;
        }

        function generateRecitals(formData) {
            return `RECITALS

WHEREAS:
A. ${getCompanyShortName(formData.companyName)} is a media and technology company that specializes in the optimization, monetization, claiming of video content and the management of online video channels;

B. Provider is an independent record label and music management company;

C. Provider operates a network of channels on YouTube and wishes to engage ${getCompanyShortName(formData.companyName)} to assist in the management of such channels, and provide content production services with respect to such channels; and

D. ${getCompanyShortName(formData.companyName)} has agreed to accept such engagement on the terms and conditions herein provided.

NOW THEREFORE THIS AGREEMENT WITNESSES that in consideration of the premises, the mutual covenants and agreements set forth in this Agreement and other good and valuable consideration (the receipt and sufficiency of which is hereby acknowledged by each of the parties), the parties hereby agree as follows:

`;
        }

        function generateSchedules(formData) {
            return `

SCHEDULES

SCHEDULE "A" ‚Äì LIST OF MANAGED CHANNELS AND ${getCompanyShortName(formData.companyName).toUpperCase()} OWNED AND OPERATED CHANNELS

[To be completed by the parties]

SCHEDULE "B" ‚Äì CHANNEL MANAGEMENT SERVICES

[To be completed based on specific services required]

SCHEDULE "C" ‚Äì CONTENT DEVELOPMENT SERVICES

[To be completed based on specific content development requirements]

`;
        }

        function formatContractHeader(formData) {
            return `${formData.agreementTitle}


BETWEEN:

${formData.companyName}
${formData.companyAddress}
("${getCompanyShortName(formData.companyName)}")

AND:

${formData.providerName}
${formData.providerAddress}
("Provider")


Effective Date: ${formData.effectiveDate}


`;
        }

        function formatClause(articleNumber, clauseNumber, clauseText) {
            // Ensure clause number stays with clause text (non-breaking)
            let formattedClause = '';

            // Add page break before new articles if needed
            if (articleNumber.startsWith('ARTICLE')) {
                formattedClause += '\n\n';
            }

            // Format the clause with proper indentation and justification
            const clauseHeader = `${articleNumber} ${clauseNumber}`;

            // Split long paragraphs and justify text
            const justifiedText = justifyText(clauseText, 80); // 80 characters per line

            formattedClause += `${clauseHeader}\n\n${justifiedText}\n\n`;

            return formattedClause;
        }

        function justifyText(text, lineLength = 80) {
            // Split text into paragraphs
            const paragraphs = text.split('\n\n');
            let justifiedParagraphs = [];

            paragraphs.forEach(paragraph => {
                if (paragraph.trim()) {
                    const words = paragraph.trim().split(/\s+/);
                    let lines = [];
                    let currentLine = [];
                    let currentLength = 0;

                    words.forEach(word => {
                        if (currentLength + word.length + currentLine.length > lineLength) {
                            if (currentLine.length > 0) {
                                lines.push(justifyLine(currentLine, lineLength));
                                currentLine = [word];
                                currentLength = word.length;
                            } else {
                                lines.push(word); // Word too long, just add it
                                currentLine = [];
                                currentLength = 0;
                            }
                        } else {
                            currentLine.push(word);
                            currentLength += word.length;
                        }
                    });

                    if (currentLine.length > 0) {
                        lines.push(currentLine.join(' ')); // Last line, don't justify
                    }

                    justifiedParagraphs.push(lines.join('\n'));
                }
            });

            return justifiedParagraphs.join('\n\n');
        }

        function justifyLine(words, targetLength) {
            if (words.length === 1) {
                return words[0];
            }

            const totalWordLength = words.reduce((sum, word) => sum + word.length, 0);
            const totalSpaces = targetLength - totalWordLength;
            const gaps = words.length - 1;

            if (gaps === 0) {
                return words[0];
            }

            const spacesPerGap = Math.floor(totalSpaces / gaps);
            const extraSpaces = totalSpaces % gaps;

            let result = '';
            for (let i = 0; i < words.length; i++) {
                result += words[i];
                if (i < words.length - 1) {
                    result += ' '.repeat(spacesPerGap);
                    if (i < extraSpaces) {
                        result += ' ';
                    }
                }
            }

            return result;
        }

        function replacePlaceholders(text, formData) {
            return text
                .replace(/RHEI CREATIONS CORP\./g, formData.companyName)
                .replace(/NINJA TUNE LTD\./g, formData.providerName)
                .replace(/600-700 Hornby Street Vancouver, British Columbia, Canada V6Z 1S4/g, formData.companyAddress)
                .replace(/90 Kennington Ln, London SE11 4XD, UK/g, formData.providerAddress)
                .replace(/May 7, 2025/g, formData.effectiveDate);
        }

        // Global functions for clause actions
        window.applyClauseChange = function(clauseNumber) {
            console.log("Applying change for clause:", clauseNumber);
            updateStatus(`Applied change for clause ${clauseNumber}`, "success");
        };

        window.previewClauseChange = function(clauseNumber) {
            console.log("Previewing change for clause:", clauseNumber);
            updateStatus(`Previewing change for clause ${clauseNumber}`, "info");
        };

        window.acceptAllChanges = function() {
            console.log("Accepting all changes...");
            updateStatus("All changes applied successfully!", "success");

            // Update UI to show all clauses as unmodified
            const modifiedClauses = document.querySelectorAll('.clause-item.modified');
            modifiedClauses.forEach(clause => {
                clause.classList.remove('modified');
                clause.classList.add('unmodified');
                const number = clause.querySelector('.clause-number');
                if (number) number.style.color = '#107c10';
                const actions = clause.querySelector('.clause-actions');
                if (actions) actions.remove();
            });

            // Hide the accept all controls
            const controls = document.querySelector('.auto-update-controls');
            if (controls) controls.style.display = 'none';
        };

        window.toggleAutoUpdate = function(enabled) {
            const acceptAllButton = document.querySelector('.accept-all-button');
            if (acceptAllButton && enabled) {
                acceptAllButton.textContent = 'üîÑ Auto-Applying Changes...';
                acceptAllButton.disabled = true;
                setTimeout(() => window.acceptAllChanges(), 1000);
            }
        };

        // Clause replacement functionality
        let selectedClause = null;
        let selectedAlternative = null;
        let currentClauseData = null;

        window.selectClause = function(clauseNumber, element) {
            // Remove previous selection
            document.querySelectorAll('.clause-item.selected').forEach(item => {
                item.classList.remove('selected');
                item.classList.remove('highlighted');
            });

            // Add selection to clicked clause
            element.classList.add('selected');
            selectedClause = clauseNumber;

            // Add visual feedback
            element.scrollIntoView({ behavior: 'smooth', block: 'center' });

            // Highlight for a moment to show selection
            setTimeout(() => {
                if (element.classList.contains('selected')) {
                    element.classList.add('highlighted');
                }
            }, 100);

            console.log("Selected clause:", clauseNumber);
            updateStatus(`Selected clause ${clauseNumber} - click Replace to choose alternative`, "info");
        };

        // Add keyboard navigation
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                // Close any open modals
                closeReplacementModal();
                closePreviewModal();

                // Clear selections
                document.querySelectorAll('.clause-item.selected').forEach(item => {
                    item.classList.remove('selected', 'highlighted');
                });
                selectedClause = null;
            }
        });

        // Add double-click to open replacement modal
        document.addEventListener('dblclick', function(event) {
            const clauseItem = event.target.closest('.clause-item');
            if (clauseItem) {
                const clauseNumber = clauseItem.dataset.clauseNumber;
                if (clauseNumber) {
                    openReplacementModal(clauseNumber);
                }
            }
        });

        window.openReplacementModal = function(clauseNumber) {
            console.log("Opening replacement modal for clause:", clauseNumber);

            // Find the clause data
            const clauseElement = document.querySelector(`[data-clause-number="${clauseNumber}"]`);
            if (!clauseElement) {
                console.error("Clause element not found for:", clauseNumber);
                return;
            }

            const clauseText = clauseElement.querySelector('.clause-text').textContent;

            // Store the current clause data globally
            currentClauseData = {
                number: clauseNumber,
                text: clauseText,
                fullText: clauseText,
                element: clauseElement // Store reference to the DOM element
            };

            console.log("Current clause data:", currentClauseData);

            // Populate modal
            document.getElementById('current-clause-text').textContent = currentClauseData.fullText;

            // Reset selection state
            selectedAlternative = null;

            // Load alternatives
            loadAlternativeClauses(clauseNumber);

            // Show modal
            document.getElementById('replacement-modal').classList.add('show');
        };

        window.closeReplacementModal = function() {
            document.getElementById('replacement-modal').classList.remove('show');
            selectedAlternative = null;
            currentClauseData = null;

            // Reset button states
            document.getElementById('preview-replacement-btn').disabled = true;
            document.getElementById('apply-replacement-btn').disabled = true;
        };

        window.closePreviewModal = function() {
            document.getElementById('preview-modal').classList.remove('show');
        };

        async function loadAlternativeClauses(clauseNumber) {
            console.log("Loading alternatives for clause:", clauseNumber);

            const container = document.getElementById('alternatives-container');
            container.innerHTML = '<div style="text-align: center; padding: 20px;">Loading alternatives...</div>';

            try {
                // Try to load alternatives from playbook service
                let alternatives = [];

                // Check if playbook service is available
                if (typeof window.playbookService !== 'undefined') {
                    alternatives = await window.playbookService.getAlternativeClauses(clauseNumber);
                } else {
                    // Fallback to mock data if service not available
                    alternatives = getMockAlternatives(clauseNumber);
                }

                // Clear loading message
                container.innerHTML = '';

                if (alternatives.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #605e5c;">No alternative clauses found for this clause.</div>';
                    return;
                }

                // Render alternatives
                alternatives.forEach(alternative => {
                    const optionElement = document.createElement('div');
                    optionElement.className = 'alternative-option';
                    optionElement.onclick = () => selectAlternative(alternative, optionElement);

                    optionElement.innerHTML = `
                        <div class="alternative-header">
                            <span class="alternative-title">${alternative.title}</span>
                            <span class="risk-badge risk-${alternative.riskLevel}">${alternative.riskLevel} risk</span>
                        </div>
                        <div class="alternative-content">${alternative.content}</div>
                    `;

                    container.appendChild(optionElement);
                });

            } catch (error) {
                console.error("Error loading alternatives:", error);
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #d13438;">Error loading alternatives. Please try again.</div>';
            }
        }

        function getMockAlternatives(clauseNumber) {
            return [
                {
                    id: 'baseline',
                    title: 'BASELINE (Ninja Tune Ltd.)',
                    content: `This is the baseline clause text for ${clauseNumber} from the RHEI Legal Matrix. It represents the standard acceptable language for this type of clause.`,
                    riskLevel: 'low',
                    recommended: true,
                    source: 'mock'
                },
                {
                    id: 'yoola',
                    title: 'Yoola Alternative',
                    content: `Alternative clause text for ${clauseNumber} suitable for Yoola agreements. This version includes specific provisions that align with Yoola requirements.`,
                    riskLevel: 'low',
                    recommended: false,
                    source: 'mock'
                },
                {
                    id: 'sony',
                    title: 'Sony Alternative',
                    content: `Sony-specific clause language for ${clauseNumber} that meets their contractual requirements while maintaining acceptable risk levels.`,
                    riskLevel: 'medium',
                    recommended: false,
                    source: 'mock'
                },
                {
                    id: 'lionsgate',
                    title: 'Lionsgate Alternative',
                    content: `Lionsgate preferred clause structure for ${clauseNumber} with enhanced liability protections and specific performance requirements.`,
                    riskLevel: 'medium',
                    recommended: false,
                    source: 'mock'
                }
            ];
        }

        function selectAlternative(alternative, element) {
            console.log("Selecting alternative:", alternative);

            // Remove previous selection
            document.querySelectorAll('.alternative-option.selected').forEach(option => {
                option.classList.remove('selected');
            });

            // Select current option
            element.classList.add('selected');

            // Store the selected alternative globally
            selectedAlternative = alternative;

            // Enable buttons
            document.getElementById('preview-replacement-btn').disabled = false;
            document.getElementById('apply-replacement-btn').disabled = false;

            console.log("Selected alternative stored:", selectedAlternative);
            console.log("Alternative content:", selectedAlternative.content);
        }

        window.previewReplacement = function() {
            if (!selectedAlternative || !currentClauseData) {
                console.error("No alternative or clause selected");
                return;
            }

            // Populate preview modal with enhanced formatting
            const beforeElement = document.getElementById('preview-before-text');
            const afterElement = document.getElementById('preview-after-text');

            beforeElement.innerHTML = formatClauseText(currentClauseData.fullText, 'before');
            afterElement.innerHTML = formatClauseText(selectedAlternative.content, 'after');

            // Add risk assessment to preview
            addRiskAssessmentToPreview(selectedAlternative);

            // Show preview modal
            document.getElementById('preview-modal').classList.add('show');
        };

        function formatClauseText(text, type) {
            // Add line breaks for better readability
            let formattedText = text.replace(/\. /g, '.<br><br>');

            // Highlight key terms
            const keyTerms = ['shall', 'must', 'may', 'will', 'agrees', 'represents', 'warrants'];
            keyTerms.forEach(term => {
                const regex = new RegExp(`\\b${term}\\b`, 'gi');
                formattedText = formattedText.replace(regex, `<strong>${term}</strong>`);
            });

            // Add styling based on type
            if (type === 'before') {
                return `<div style="color: #605e5c;">${formattedText}</div>`;
            } else {
                return `<div style="color: #0078d4;">${formattedText}</div>`;
            }
        }

        function addRiskAssessmentToPreview(alternative) {
            // Find or create risk assessment section
            let riskSection = document.getElementById('preview-risk-assessment');
            if (!riskSection) {
                riskSection = document.createElement('div');
                riskSection.id = 'preview-risk-assessment';
                riskSection.style.marginTop = '15px';
                riskSection.style.padding = '10px';
                riskSection.style.borderRadius = '4px';
                riskSection.style.fontSize = '13px';

                // Insert after the "After" section
                const afterSection = document.querySelector('#preview-modal .alternatives-section');
                afterSection.appendChild(riskSection);
            }

            // Set risk level styling and content
            const riskLevel = alternative.riskLevel || 'medium';
            const riskColors = {
                low: { bg: '#dff6dd', color: '#107c10' },
                medium: { bg: '#fff4ce', color: '#797673' },
                high: { bg: '#fde7e9', color: '#d13438' }
            };

            const colors = riskColors[riskLevel];
            riskSection.style.backgroundColor = colors.bg;
            riskSection.style.color = colors.color;
            riskSection.style.border = `1px solid ${colors.color}`;

            riskSection.innerHTML = `
                <strong>Risk Assessment:</strong> ${riskLevel.toUpperCase()} RISK<br>
                <small>Source: ${alternative.source || 'Unknown'}</small>
                ${alternative.recommended ? '<br><small>‚úì Recommended option</small>' : ''}
            `;
        }

        window.confirmReplacement = function() {
            showReplacementProgress();
            applyReplacement();
        };

        window.applyReplacement = async function() {
            console.log("=== APPLY REPLACEMENT CALLED ===");
            console.log("Selected alternative:", selectedAlternative);
            console.log("Current clause data:", currentClauseData);

            if (!selectedAlternative || !currentClauseData) {
                console.error("Missing data - Alternative:", !!selectedAlternative, "Clause:", !!currentClauseData);
                updateStatus("‚ùå Error: No alternative or clause selected", "error");
                return;
            }

            console.log(`Applying replacement for clause ${currentClauseData.number}`);
            console.log(`Alternative: ${selectedAlternative.title}`);
            console.log(`Old text: ${currentClauseData.fullText.substring(0, 50)}...`);
            console.log(`New text: ${selectedAlternative.content.substring(0, 50)}...`);

            try {
                // Show progress
                updateStatus(`Replacing clause ${currentClauseData.number} with ${selectedAlternative.title}...`, "info");

                // Perform the replacement in the document
                await replaceClauseInDocument(currentClauseData.number, selectedAlternative.content);

                // Update UI to reflect successful replacement
                updateClauseInAnalysisView(currentClauseData.number, selectedAlternative);

                // Show success message
                updateStatus(`‚úÖ Clause ${currentClauseData.number} replaced with ${selectedAlternative.title}`, "success");

                // Log the replacement for audit trail
                logClauseReplacement(currentClauseData, selectedAlternative);

                console.log("=== REPLACEMENT COMPLETED SUCCESSFULLY ===");

            } catch (error) {
                console.error("Error applying replacement:", error);
                updateStatus(`‚ùå Failed to replace clause ${currentClauseData.number}: ${error.message}`, "error");
            } finally {
                // Close modals
                closePreviewModal();
                closeReplacementModal();
            }
        };

        function showReplacementProgress() {
            // Update preview modal to show progress
            const confirmButton = document.querySelector('#preview-modal .modal-button-apply');
            if (confirmButton) {
                confirmButton.textContent = 'Applying...';
                confirmButton.disabled = true;
            }
        }

        function updateClauseInAnalysisView(clauseNumber, alternative) {
            console.log("Updating clause in analysis view:", clauseNumber, alternative);

            // Use the stored element reference if available, otherwise find it
            let clauseElement = currentClauseData && currentClauseData.element ?
                currentClauseData.element :
                document.querySelector(`[data-clause-number="${clauseNumber}"]`);

            if (clauseElement) {
                console.log("Found clause element, updating...");

                // Update visual indicators
                clauseElement.classList.remove('modified', 'selected', 'highlighted');
                clauseElement.classList.add('replaced');

                // Update clause text preview with the actual alternative content
                const clauseTextElement = clauseElement.querySelector('.clause-text');
                if (clauseTextElement) {
                    const previewText = alternative.content.substring(0, 100);
                    clauseTextElement.textContent = previewText + (alternative.content.length > 100 ? '...' : '');
                    clauseTextElement.style.color = '#0078d4'; // Blue to indicate replacement
                    console.log("Updated clause text to:", previewText);
                }

                // Update clause number color
                const clauseNumberElement = clauseElement.querySelector('.clause-number');
                if (clauseNumberElement) {
                    clauseNumberElement.style.color = '#0078d4'; // Blue to indicate replacement
                }

                // Add replacement indicator (remove existing first)
                let existingIndicator = clauseElement.querySelector('.replacement-indicator');
                if (existingIndicator) {
                    existingIndicator.remove();
                }

                const replacementIndicator = document.createElement('span');
                replacementIndicator.className = 'replacement-indicator';
                replacementIndicator.style.marginLeft = '8px';
                replacementIndicator.style.fontSize = '11px';
                replacementIndicator.style.color = '#0078d4';
                replacementIndicator.style.fontWeight = 'bold';
                replacementIndicator.textContent = `üîÑ REPLACED (${alternative.title})`;

                const actionsElement = clauseElement.querySelector('.clause-actions');
                if (actionsElement) {
                    actionsElement.appendChild(replacementIndicator);
                } else {
                    clauseElement.appendChild(replacementIndicator);
                }

                console.log("Clause updated successfully");
            } else {
                console.error("Clause element not found for:", clauseNumber);
            }
        }

        function logClauseReplacement(originalClause, newAlternative) {
            // Create audit log entry
            const logEntry = {
                timestamp: new Date().toISOString(),
                clauseNumber: originalClause.number,
                originalText: originalClause.fullText,
                newText: newAlternative.content,
                alternativeTitle: newAlternative.title,
                riskLevel: newAlternative.riskLevel,
                source: newAlternative.source,
                userAction: 'manual_replacement'
            };

            // Store in session storage for this session
            const existingLog = JSON.parse(sessionStorage.getItem('clauseReplacements') || '[]');
            existingLog.push(logEntry);
            sessionStorage.setItem('clauseReplacements', JSON.stringify(existingLog));

            console.log("Clause replacement logged:", logEntry);
        }

        // Test function for clause replacement functionality
        window.testClauseReplacement = function() {
            console.log("üß™ Testing clause replacement functionality...");

            // Check if clauses are already loaded
            const existingClauses = document.querySelectorAll('.clause-item');

            if (existingClauses.length === 0) {
                // First, trigger a demo analysis to get clauses
                displayDemoAnalysis();

                // Wait a moment for the analysis to render
                setTimeout(() => {
                    performClauseTest();
                }, 1000);
            } else {
                // Clauses already exist, just run the test
                console.log("Using existing clauses for test...");
                performClauseTest();
            }
        };

        function performClauseTest() {
            console.log("üß™ Starting clause replacement test...");

            // Test 1: Check if clauses are clickable
            const clauseItems = document.querySelectorAll('.clause-item');
            console.log(`‚úì Found ${clauseItems.length} clause items`);

            if (clauseItems.length > 0) {
                // Test 2: Find an unmodified clause to test
                let testClause = null;

                // Look for a clause that hasn't been replaced yet
                for (let clause of clauseItems) {
                    if (!clause.innerHTML.includes('‚úÖ REPLACED')) {
                        testClause = clause;
                        break;
                    }
                }

                // If all clauses are replaced, use a random one
                if (!testClause) {
                    testClause = clauseItems[Math.floor(Math.random() * clauseItems.length)];
                    console.log("All clauses already replaced, testing random clause...");
                }

                const clauseNumber = testClause.dataset.clauseNumber;
                console.log(`‚úì Testing selection of clause ${clauseNumber}`);

                // Simulate click
                selectClause(clauseNumber, testClause);

                console.log("‚úÖ Basic clause replacement test completed");
            } else {
                console.log("‚ùå No clause items found");
            }
        }

        // Add debug tools to the UI
        window.addEventListener('load', function() {
            console.log("Page loaded, adding debug tools...");
            setTimeout(() => {
                addDebugTools();
            }, 1000);
        });

        function addDebugTools() {
            console.log("Adding debug tools...");

            const debugSection = document.querySelector('.debug-section');
            const debugContent = document.getElementById('debug-content');

            if (debugSection && debugContent) {
                console.log("Debug section found, adding tools...");

                // Clear the placeholder text
                debugContent.innerHTML = '';

                // Add test button
                const testButton = document.createElement('button');
                testButton.textContent = 'üß™ Test Clause Replacement';
                testButton.className = 'form-button';
                testButton.style.marginRight = '10px';
                testButton.style.marginBottom = '10px';
                testButton.onclick = testClauseReplacement;
                debugContent.appendChild(testButton);

                // Add analyze button for quick testing
                const analyzeButton = document.createElement('button');
                analyzeButton.textContent = 'üìä Quick Analysis';
                analyzeButton.className = 'form-button';
                analyzeButton.style.marginRight = '10px';
                analyzeButton.style.marginBottom = '10px';
                analyzeButton.onclick = () => {
                    console.log("Running quick analysis...");
                    displayDemoAnalysis();
                };
                debugContent.appendChild(analyzeButton);

                // Add status info
                const statusDiv = document.createElement('div');
                statusDiv.style.fontSize = '11px';
                statusDiv.style.color = '#605e5c';
                statusDiv.style.marginTop = '10px';
                statusDiv.innerHTML = `
                    <strong>Status:</strong><br>
                    ‚Ä¢ Word API: ${typeof Word !== 'undefined' ? '‚úÖ Available' : '‚ùå Not Available'}<br>
                    ‚Ä¢ Playbook Service: ${typeof window.playbookService !== 'undefined' ? '‚úÖ Loaded' : '‚ùå Not Loaded'}<br>
                    ‚Ä¢ Page Load: ‚úÖ Complete
                `;
                debugContent.appendChild(statusDiv);

                console.log("Debug tools added successfully!");
            } else {
                console.error("Debug section not found!");
            }
        }

        async function replaceClauseInDocument(clauseNumber, newText) {
            console.log("Replacing clause in document:", clauseNumber);

            try {
                if (typeof Word !== 'undefined' && typeof Word.run === 'function') {
                    await Word.run(async (context) => {
                        const body = context.document.body;

                        // Strategy 1: Try to find clause by number pattern
                        let clauseFound = await findAndReplaceClauseByNumber(context, body, clauseNumber, newText);

                        if (!clauseFound) {
                            // Strategy 2: Try to find clause by searching for the current text
                            clauseFound = await findAndReplaceClauseByText(context, body, clauseNumber, newText);
                        }

                        if (!clauseFound) {
                            // Strategy 3: Insert replacement at the end with clear marking
                            await insertReplacementAtEnd(context, body, clauseNumber, newText);
                        }

                        await context.sync();
                        console.log("Clause replacement completed");
                    });
                } else {
                    console.log("Word API not available - simulating replacement");
                    simulateClauseReplacement(clauseNumber, newText);
                }
            } catch (error) {
                console.error("Error replacing clause:", error);
                updateStatus("Error replacing clause: " + error.message, "error");
                throw error;
            }
        }

        async function findAndReplaceClauseByNumber(context, body, clauseNumber, newText) {
            try {
                // Search for clause number patterns like "1.1", "2.3", etc.
                const searchPatterns = [
                    `${clauseNumber}.`,
                    `${clauseNumber} `,
                    `Article ${clauseNumber}`,
                    `Section ${clauseNumber}`,
                    `Clause ${clauseNumber}`
                ];

                for (const pattern of searchPatterns) {
                    const searchResults = body.search(pattern, { matchCase: false, matchWholeWord: false });
                    searchResults.load(["items"]);
                    await context.sync();

                    if (searchResults.items.length > 0) {
                        console.log(`Found clause using pattern: ${pattern}`);

                        // Get the paragraph containing the clause
                        const range = searchResults.items[0];
                        const paragraph = range.paragraph;
                        paragraph.load(["text"]);
                        await context.sync();

                        // Replace the entire paragraph with the new clause
                        await replaceClauseParagraph(context, paragraph, clauseNumber, newText);
                        return true;
                    }
                }

                return false;
            } catch (error) {
                console.error("Error in findAndReplaceClauseByNumber:", error);
                return false;
            }
        }

        async function findAndReplaceClauseByText(context, body, clauseNumber, newText) {
            try {
                // If we have the current clause data, try to find it by text content
                if (currentClauseData && currentClauseData.fullText) {
                    const searchText = currentClauseData.fullText.substring(0, 50); // First 50 chars
                    const searchResults = body.search(searchText, { matchCase: false, matchWholeWord: false });
                    searchResults.load(["items"]);
                    await context.sync();

                    if (searchResults.items.length > 0) {
                        console.log("Found clause by text content");

                        const range = searchResults.items[0];
                        const paragraph = range.paragraph;
                        paragraph.load(["text"]);
                        await context.sync();

                        await replaceClauseParagraph(context, paragraph, clauseNumber, newText);
                        return true;
                    }
                }

                return false;
            } catch (error) {
                console.error("Error in findAndReplaceClauseByText:", error);
                return false;
            }
        }

        async function replaceClauseParagraph(context, paragraph, clauseNumber, newText) {
            try {
                // Clear the paragraph and insert new text
                paragraph.clear();

                // Insert the new clause with proper formatting
                const newClauseText = `${clauseNumber}. ${newText}`;
                const insertedRange = paragraph.insertText(newClauseText, Word.InsertLocation.start);

                // Apply formatting to make it clear this is a replacement
                insertedRange.font.color = "#0078d4"; // Blue color to indicate change
                insertedRange.font.bold = false;

                // Add a comment to track the change
                try {
                    insertedRange.insertComment(`Clause ${clauseNumber} replaced via RHEI AI Legal Assistant`);
                } catch (commentError) {
                    console.log("Could not add comment (may not be supported):", commentError);
                }

                await context.sync();
                console.log(`Successfully replaced clause ${clauseNumber}`);

            } catch (error) {
                console.error("Error in replaceClauseParagraph:", error);
                throw error;
            }
        }

        async function insertReplacementAtEnd(context, body, clauseNumber, newText) {
            try {
                // Insert at the end of the document with clear marking
                const endRange = body.insertText("\n\n--- CLAUSE REPLACEMENT ---\n", Word.InsertLocation.end);
                endRange.font.bold = true;
                endRange.font.color = "#d13438"; // Red color for attention

                const clauseRange = body.insertText(`Clause ${clauseNumber} (Replacement):\n${newText}\n`, Word.InsertLocation.end);
                clauseRange.font.color = "#0078d4"; // Blue color for new content

                const noteRange = body.insertText("Note: This clause replacement was added at the end of the document. Please review and move to the appropriate location.\n", Word.InsertLocation.end);
                noteRange.font.italic = true;
                noteRange.font.color = "#605e5c";

                await context.sync();
                console.log(`Inserted replacement for clause ${clauseNumber} at end of document`);

            } catch (error) {
                console.error("Error in insertReplacementAtEnd:", error);
                throw error;
            }
        }

        function simulateClauseReplacement(clauseNumber, newText) {
            console.log("=== SIMULATED CLAUSE REPLACEMENT ===");
            console.log(`Clause Number: ${clauseNumber}`);
            console.log(`New Text: ${newText.substring(0, 100)}...`);
            console.log("=====================================");

            // Update the UI to show the replacement was simulated
            updateStatus(`Simulated replacement of clause ${clauseNumber} (Word API not available)`, "warning");
        }

        // Set up event listeners when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM ready, setting up event listeners...");

            // Set default effective date to today
            const effectiveDateInput = document.getElementById('effective-date');
            if (effectiveDateInput) {
                const today = new Date().toISOString().split('T')[0];
                effectiveDateInput.value = today;
            }

            const generateBtn = document.getElementById('generate-contract');
            if (generateBtn) {
                console.log("üéØ Setting up event listener for generate-contract button");
                console.log("Button element:", generateBtn);
                console.log("Button disabled state:", generateBtn.disabled);
                generateBtn.addEventListener('click', generateContract);
                console.log("‚úÖ Event listener added to generate-contract button");

                // Test the event listener immediately
                generateBtn.addEventListener('click', function() {
                    console.log("üî• BUTTON CLICK DETECTED!");
                });
            } else {
                console.error("‚ùå Generate contract button not found!");
            }

            // Add change listener to contract type dropdown
            const contractTypeSelect = document.getElementById('contract-type-select');
            if (contractTypeSelect) {
                contractTypeSelect.addEventListener('change', function() {
                    updateStatus(`Selected contract type: ${this.value}`, "info");
                    updateFormForContractType(this.value);
                });
            }
        });

        function updateFormForContractType(contractType) {
            const agreementTitleInput = document.getElementById('agreement-title');
            if (agreementTitleInput) {
                if (contractType === 'content-management') {
                    agreementTitleInput.value = 'DIGITAL VIDEO SERVICES AGREEMENT';
                } else if (contractType === 'data-pro') {
                    agreementTitleInput.value = 'DATA LICENSE AGREEMENT';
                }
            }
        }
    </script>

    <!-- Basic styles -->
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 400px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #0078d4;
            margin-top: 0;
        }
        button {
            background-color: #0078d4;
            color: white;
            border: none;
            padding: 10px 15px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        button:hover:not(:disabled) {
            background-color: #106ebe;
        }
        .status-message {
            margin: 15px 0;
            padding: 10px;
            border-radius: 4px;
            background-color: #f0f0f0;
        }
        .status-message.success {
            background-color: #d4edda;
            color: #155724;
        }
        .status-message.error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .status-message.warning {
            background-color: #fff3cd;
            color: #856404;
        }
        .status-message.info {
            background-color: #d1ecf1;
            color: #0c5460;
        }


        /* Contract Type Section */
        .contract-type-section {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e1e5e9;
        }

        .dropdown-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #323130;
            font-size: 14px;
        }

        .contract-dropdown {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #0078d4;
            border-radius: 4px;
            background-color: white;
            font-size: 14px;
            color: #323130;
            cursor: pointer;
        }

        .contract-dropdown:focus {
            outline: none;
            border-color: #106ebe;
            box-shadow: 0 0 0 2px rgba(0, 120, 212, 0.2);
        }

        /* Generate Section */
        .generate-section {
            margin: 20px 0;
            text-align: center;
        }

        .blue-button {
            background-color: #0078d4;
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            min-width: 200px;
            transition: background-color 0.2s ease;
        }

        .blue-button:hover {
            background-color: #106ebe;
        }

        .blue-button:active {
            background-color: #005a9e;
        }

        .blue-button:disabled {
            background-color: #a19f9d;
            cursor: not-allowed;
        }

        /* Contract Form Section */
        .contract-form-section {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e1e5e9;
        }

        .form-section-title {
            margin: 0 0 15px 0;
            color: #0078d4;
            font-size: 16px;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #323130;
            font-size: 13px;
        }

        .form-input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #d2d0ce;
            border-radius: 4px;
            font-size: 14px;
            color: #323130;
            background-color: white;
            box-sizing: border-box;
        }

        .form-input:focus {
            outline: none;
            border-color: #0078d4;
            box-shadow: 0 0 0 2px rgba(0, 120, 212, 0.2);
        }

        .form-input[readonly] {
            background-color: #f3f2f1;
            color: #605e5c;
            cursor: not-allowed;
        }

        .form-textarea {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #d2d0ce;
            border-radius: 4px;
            font-size: 14px;
            color: #323130;
            background-color: white;
            box-sizing: border-box;
            min-height: 60px;
            resize: vertical;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .form-textarea:focus {
            outline: none;
            border-color: #0078d4;
            box-shadow: 0 0 0 2px rgba(0, 120, 212, 0.2);
        }

        /* Contract Preview Styles */
        .contract-preview {
            background: #ffffff;
            padding: 30px;
            border: 1px solid #d2d0ce;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: 'Times New Roman', serif;
            font-size: 12px;
            line-height: 1.6;
            max-height: 500px;
            overflow-y: auto;
            text-align: justify;
            text-justify: inter-word;
            margin: 15px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .contract-preview h3 {
            text-align: center;
            font-weight: bold;
            margin-bottom: 20px;
        }

        /* Results Section */
        .results-section {
            margin-top: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 6px;
            border: 1px solid #e1e1e1;
        }

        /* Contract Structure */
        .contract-structure {
            margin-bottom: 20px;
        }
        .articles-breakdown {
            margin-top: 15px;
        }
        .article-item {
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 4px;
            border: 1px solid #e1e1e1;
        }
        .article-title {
            color: #0078d4;
            margin: 0 0 10px 0;
            font-size: 16px;
            font-weight: 600;
        }
        .clauses-list {
            margin-left: 15px;
        }
        .clause-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f3f2f1;
        }
        .clause-item:last-child {
            border-bottom: none;
        }
        .clause-number {
            font-weight: 600;
            margin-right: 10px;
            min-width: 40px;
        }
        .clause-text {
            flex: 1;
            font-size: 13px;
            color: #605e5c;
        }
        .clause-item.modified .clause-number {
            color: #d13438 !important;
        }
        .clause-item.unmodified .clause-number {
            color: #107c10 !important;
        }

        /* Clause Actions */
        .clause-actions {
            margin-left: 10px;
            display: flex;
            gap: 4px;
            align-items: center;
        }
        .modify-button, .preview-button, .replace-button {
            background-color: #0078d4;
            color: white;
            border: none;
            padding: 4px 8px;
            margin: 0 2px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            transition: background-color 0.2s;
        }
        .preview-button {
            background-color: #605e5c;
        }
        .replace-button {
            background-color: #8764b8;
        }
        .modify-button:hover, .preview-button:hover, .replace-button:hover {
            opacity: 0.8;
        }

        /* Clause Highlighting */
        .clause-item {
            cursor: pointer;
            transition: background-color 0.2s, border-left 0.2s;
            position: relative;
        }
        .clause-item:hover {
            background-color: #f8f9fa;
        }
        .clause-item.selected {
            background-color: #e3f2fd;
            border-left: 4px solid #0078d4;
            padding-left: 8px;
        }
        .clause-item.highlighted {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            padding-left: 8px;
        }
        .clause-item.replaced {
            background-color: #e3f2fd;
            border-left: 4px solid #0078d4;
            padding-left: 8px;
        }
        .replacement-indicator {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Accept All Controls */
        .auto-update-controls {
            margin: 15px 0;
            padding: 15px;
            background: #f3f2f1;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .auto-update-checkbox {
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        .auto-update-checkbox input {
            margin-right: 8px;
        }
        .accept-all-button {
            background-color: #107c10;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
        }
        .accept-all-button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        /* Clause Replacement Modal */
        .replacement-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        .replacement-modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .replacement-modal-content {
            background: white;
            border-radius: 8px;
            padding: 20px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }
        .replacement-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e1dfdd;
        }
        .replacement-modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #323130;
        }
        .close-modal {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #605e5c;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .close-modal:hover {
            background-color: #f3f2f1;
            border-radius: 4px;
        }

        /* Current Clause Display */
        .current-clause-section {
            margin-bottom: 20px;
        }
        .current-clause-label {
            font-weight: 600;
            color: #323130;
            margin-bottom: 8px;
        }
        .current-clause-text {
            background-color: #fef7f1;
            border: 1px solid #fdcfb4;
            border-radius: 4px;
            padding: 12px;
            font-size: 13px;
            line-height: 1.4;
            color: #605e5c;
        }

        /* Alternative Clauses */
        .alternatives-section {
            margin-bottom: 20px;
        }
        .alternatives-label {
            font-weight: 600;
            color: #323130;
            margin-bottom: 12px;
        }
        .alternative-option {
            border: 1px solid #e1dfdd;
            border-radius: 4px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: border-color 0.2s, background-color 0.2s;
        }
        .alternative-option:hover {
            border-color: #0078d4;
            background-color: #f8f9fa;
        }
        .alternative-option.selected {
            border-color: #0078d4;
            background-color: #e3f2fd;
        }
        .alternative-header {
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f8f9fa;
            border-bottom: 1px solid #e1dfdd;
        }
        .alternative-title {
            font-weight: 600;
            color: #323130;
            font-size: 14px;
        }
        .risk-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .risk-low {
            background-color: #dff6dd;
            color: #107c10;
        }
        .risk-medium {
            background-color: #fff4ce;
            color: #797673;
        }
        .risk-high {
            background-color: #fde7e9;
            color: #d13438;
        }
        .alternative-content {
            padding: 12px;
            font-size: 13px;
            line-height: 1.4;
            color: #605e5c;
        }

        /* Modal Actions */
        .replacement-modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e1dfdd;
        }
        .modal-button {
            padding: 8px 16px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
        }
        .modal-button-cancel {
            background-color: #f3f2f1;
            color: #323130;
        }
        .modal-button-preview {
            background-color: #605e5c;
            color: white;
        }
        .modal-button-apply {
            background-color: #0078d4;
            color: white;
        }
        .modal-button:hover {
            opacity: 0.8;
        }
        .modal-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Progress Section */
        .progress-section {
            margin: 20px 0;
            padding: 20px;
            text-align: center;
            background: #f9f9f9;
            border-radius: 6px;
        }
        .progress-spinner {
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #0078d4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Contract Type Selection -->
        <div class="contract-type-section">
            <label for="contract-type-select" class="dropdown-label">Contract Type:</label>
            <select id="contract-type-select" class="contract-dropdown">
                <option value="content-management">Content Management Agreement</option>
                <option value="data-pro">Data Pro Agreement</option>
            </select>
        </div>

        <!-- Contract Details Form -->
        <div class="contract-form-section">
            <h3 class="form-section-title">Contract Details</h3>

            <!-- Provider Information -->
            <div class="form-group">
                <label for="provider-name" class="form-label">Provider/Client Name:</label>
                <input type="text" id="provider-name" class="form-input" value="" placeholder="Enter provider/client company name">
            </div>

            <div class="form-group">
                <label for="provider-address" class="form-label">Provider/Client Address:</label>
                <textarea id="provider-address" class="form-textarea" placeholder="Enter provider/client full address"></textarea>
            </div>

            <!-- Contract Details -->
            <div class="form-group">
                <label for="effective-date" class="form-label">Effective Date:</label>
                <input type="date" id="effective-date" class="form-input" value="">
            </div>

            <div class="form-group">
                <label for="agreement-title" class="form-label">Agreement Title:</label>
                <input type="text" id="agreement-title" class="form-input" value="DIGITAL VIDEO SERVICES AGREEMENT" placeholder="Enter agreement title" readonly>
            </div>
        </div>

        <!-- Generate Contract Button -->
        <div class="generate-section">
            <button id="generate-contract" class="blue-button" onclick="generateContract()">üìÑ Generate Contract</button>
        </div>

        <!-- Status Message (Debug Text) -->
        <div id="status-message" class="status-message">
            Initializing...
        </div>

        <!-- Results Section -->
        <div id="results-section" class="results-section" style="display: none;">
            <div id="results-content"></div>
        </div>

        <!-- Progress Section -->
        <div id="progress-section" class="progress-section" style="display: none;">
            <div class="progress-content">
                <div class="progress-spinner"></div>
                <div id="progress-message">Processing...</div>
            </div>
        </div>

        <!-- Debug Section -->
        <div class="debug-section" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 4px; border: 1px solid #e1dfdd;">
            <h4 style="margin: 0 0 10px 0; color: #323130; font-size: 14px;">Debug & Testing</h4>
            <div id="debug-content">
                <p style="margin: 0; font-size: 12px; color: #605e5c;">Debug tools and testing functions will appear here.</p>
            </div>
        </div>
    </div>

    <!-- Clause Replacement Modal -->
    <div id="replacement-modal" class="replacement-modal">
        <div class="replacement-modal-content">
            <div class="replacement-modal-header">
                <h3 class="replacement-modal-title">Replace Clause</h3>
                <button class="close-modal" onclick="closeReplacementModal()">&times;</button>
            </div>

            <div class="current-clause-section">
                <div class="current-clause-label">Current Clause:</div>
                <div id="current-clause-text" class="current-clause-text"></div>
            </div>

            <div class="alternatives-section">
                <div class="alternatives-label">Select Alternative Clause:</div>
                <div id="alternatives-container"></div>
            </div>

            <div class="replacement-modal-actions">
                <button class="modal-button modal-button-cancel" onclick="closeReplacementModal()">Cancel</button>
                <button class="modal-button modal-button-preview" onclick="previewReplacement()" id="preview-replacement-btn" disabled>Preview</button>
                <button class="modal-button modal-button-apply" onclick="applyReplacement()" id="apply-replacement-btn" disabled>Apply Replacement</button>
            </div>
        </div>
    </div>

    <!-- Preview Modal -->
    <div id="preview-modal" class="replacement-modal">
        <div class="replacement-modal-content">
            <div class="replacement-modal-header">
                <h3 class="replacement-modal-title">Preview Clause Replacement</h3>
                <button class="close-modal" onclick="closePreviewModal()">&times;</button>
            </div>

            <div class="current-clause-section">
                <div class="current-clause-label">Before (Current):</div>
                <div id="preview-before-text" class="current-clause-text"></div>
            </div>

            <div class="alternatives-section">
                <div class="alternatives-label">After (New):</div>
                <div id="preview-after-text" class="alternative-content" style="background-color: #e3f2fd; border: 1px solid #0078d4; border-radius: 4px; padding: 12px;"></div>
            </div>

            <div class="replacement-modal-actions">
                <button class="modal-button modal-button-cancel" onclick="closePreviewModal()">Back</button>
                <button class="modal-button modal-button-apply" onclick="confirmReplacement()">Confirm Replacement</button>
            </div>
        </div>
    </div>

</body>

</html>
